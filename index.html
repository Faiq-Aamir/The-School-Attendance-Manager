<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>Student Attendance</title>
<style>
/* ============================================
   CSS VARIABLES & RESET
============================================ */
:root {
    --primary: #667eea;
    --secondary: #764ba2;
    --success: #43e97b;
    --success-dark: #2e7d32;
    --danger: #eb1559;
    --danger-dark: #c62828;
    --warning: #ffcc00;
    --dark: #333;
    --light: #ffffff;
    --border: #ddd;
    --border-focus: #667eea;
    --shadow-sm: 0 4px 12px rgba(0, 0, 0, 0.1);
    --shadow-md: 0 8px 20px rgba(0, 0, 0, 0.25);
    --shadow-lg: 0 15px 35px rgba(0, 0, 0, 0.25);
    --shadow-xl: 0 15px 30px rgba(0, 0, 0, 0.35);
    --transition: all 0.3s ease;
    --transition-slow: all 0.4s ease;
    --glass: rgba(255, 255, 255, 0.1);
    --glass-light: rgba(255, 255, 255, 0.9);
}

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

html,
body {
    overflow-x: hidden;
    width: 100%;
}

* {
    max-width: 100%;
}

/* ============================================
   BODY & LAYOUT
============================================ */
body {
    font-family: "Segoe UI", Tahoma, sans-serif;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    min-height: 100vh;
    color: var(--dark);
    padding: 15px;
    padding-bottom: 90px;
}

h1 {
    text-align: center;
    color: #ffffff;
    text-shadow: 0 0 5px black, 0 0 10px #292323, 0 0 20px darkgray;
    padding: 20px 10px;
    font-size: clamp(24px, 4vw, 36px);
    letter-spacing: 1px;
}

/* ============================================
   CONTAINER
============================================ */
.container {
    max-width: 1000px;
    margin: auto;
    background: var(--glass-light);
    backdrop-filter: blur(8px);
    border-radius: 18px;
    padding: 25px;
    box-shadow: var(--shadow-lg);
    animation: fadeIn 0.6s ease-in-out;
    overflow: visible;
    border: 1px solid rgba(255, 255, 255, 0.3);
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* ============================================
   INPUT FIELDS
============================================ */
.input-box {
    text-align: center;
    margin-bottom: 25px;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px;
}

input[type="text"],
input[type="number"],
input[type="date"] {
    padding: 16px 18px;
    border-radius: 10px;
    border: 2px solid var(--border);
    font-size: 17px;
    width: 100%;
    max-width: 100%;
    transition: var(--transition);
    background: white;
}

input[type="text"]:focus,
input[type="number"]:focus,
input[type="date"]:focus {
    border-color: var(--border-focus);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1), 0 0 10px rgba(102, 126, 234, 0.4);
    outline: none;
}

/* ============================================
   TOOLBAR & SEARCH
============================================ */
.toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
    background: var(--glass);
    backdrop-filter: blur(10px);
    padding: 15px;
    border-radius: 12px;
    width: 100%;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.toolbar input[type="text"] {
    flex: 1;
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.toolbar input[type="text"]:focus {
    background: white;
    border-color: var(--primary);
}

/* ============================================
   BUTTON SYSTEM
============================================ */
button {
    position: relative;
    padding: 12px 22px;
    border: none;
    border-radius: 14px;
    cursor: pointer;
    font-weight: 600;
    font-size: 15px;
    min-width: 120px;
    transition: var(--transition-slow);
    box-shadow: var(--shadow-md);
    overflow: hidden;
}

button::before {
    content: "";
    position: absolute;
    inset: 0;
    background: rgba(255, 255, 255, 0.25);
    opacity: 0;
    transition: var(--transition);
}

button:hover::before {
    opacity: 1;
}

button:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: var(--shadow-xl);
}

button:active {
    transform: scale(0.96);
}

button:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.5), var(--shadow-md);
}

.add-btn {
    background: linear-gradient(135deg, #00f2fe, #4facfe, var(--success));
    color: #003;
}

.add-btn:hover {
    transform: translateY(-5px);
}

.present-btn {
    background: linear-gradient(135deg, #11998e, #38ef7d);
    color: white;
}

.absent-btn {
    background: linear-gradient(135deg, var(--danger), #ffb199);
    color: white;
}

.delete-btn {
    background: linear-gradient(135deg, #f00000, var(--warning));
    color: white;
}

.export-btn {
    background: linear-gradient(135deg, #36d1dc, #5b86e5);
    color: white;
    font-weight: 600;
    border-radius: 14px;
    box-shadow: var(--shadow-md);
}

.import-btn {
    background: linear-gradient(135deg, #f7971e, #ffd200);
    color: #333;
    font-weight: 600;
    border-radius: 14px;
    box-shadow: var(--shadow-md);
}

.total-present-btn {
    background: linear-gradient(135deg, #a8e063, #56ab2f);
    color: white;
    font-weight: 600;
    border-radius: 14px;
    padding: 12px 22px;
    cursor: pointer;
    box-shadow: var(--shadow-md);
    transition: var(--transition-slow);
}

.total-present-btn:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-xl);
}

.export-btn:hover,
.import-btn:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-xl);
}

.btn-icon {
    width: 18px;
    height: 18px;
    margin-right: 8px;
    stroke: currentColor;
    fill: none;
    stroke-width: 2;
    stroke-linecap: round;
    stroke-linejoin: round;
    vertical-align: middle;
}

/* ============================================
   BUTTON GROUP & CONTEXT MENU
============================================ */
.btn-group {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    justify-content: center;
    position: relative;
}

.btn-group {
    position: relative;
    z-index: 1;
}

.action-cell {
    position: relative;
    z-index: 10;
}

.action-cell .btn-group {
    position: relative;
    z-index: 10;
}

.btn-group .context-menu {
    position: absolute;
    top: 100%; 
    right: 0;
    display: none; 
    flex-direction: column;
    background: black; 
    border-radius: 10px;
    padding: 8px;
    min-width: 160px;
    z-index: 9999;
    box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    opacity: 90%;
}

.btn-group .context-menu div {
    padding: 10px;
    color: white;
    cursor: pointer;
    border-radius: 6px;
    font-size: 14px;
    transition: var(--transition);
}

.btn-group .context-menu .menu-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 14px;
    user-select: none;
    cursor: pointer;
    pointer-events: auto;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
}

.btn-group .context-menu .menu-item i {
    width: 16px;
    text-align: center;
    opacity: 0.8;
    pointer-events: none;
}

.btn-group .context-menu .menu-item:hover {
    background: rgba(255, 255, 255, 0.15);
    transform: translateX(5px);
}

.btn-group .context-menu .menu-item:active {
    background: rgba(255, 255, 255, 0.25);
    transform: translateX(3px);
}

.menu-btn {
    font-size: 25px;
    margin-left: 10px;
    cursor: pointer;
    transition: var(--transition);
    border-radius: 50%;
    width: 30px;
    height: 40px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.menu-btn:hover {
    transform: scale(1.2);
    background: rgba(191, 194, 205, 0.3);
}

/* ============================================
   TABLE STYLING
============================================ */
.table-wrapper {
    width: 100%;
    overflow-x: auto;
    border-radius: 12px;
    box-shadow: var(--shadow-sm);
}

table {
    width: 100%;
    border-collapse: collapse;
    table-layout: auto;
    min-width: unset !important;
    background: white;
    border-radius: 12px;
    overflow: hidden;
}

th {
    background: linear-gradient(to right, var(--primary), var(--secondary));
    color: white;
    padding: 14px;
    font-size: 15px;
    text-transform: uppercase;
    font-weight: 600;
    letter-spacing: 0.5px;
}

td {
    padding: 12px;
    text-align: center;
    font-size: 14px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    vertical-align: middle;
}

td.status-cell {
    margin-top: 10px;
    padding-top: 15px;
}

/* Mobile status cell styling */
@media (max-width: 600px) {
    td.status-cell {
        margin-top: 5px;
        padding-top: 8px;
        padding-bottom: 8px;
        font-size: 12px;
    }
    
    .present,
    .absent {
        padding: 4px 8px;
        font-size: 10px;
        display: inline-block;
        white-space: nowrap;
    }
    
    td {
        padding: 8px 4px;
        font-size: 12px;
    }
    
    th {
        padding: 10px 4px;
        font-size: 12px;
    }
}

tr:nth-child(even) {
    background: #f6f7ff;
}

tr:hover {
    background: #eef1ff;
    transition: var(--transition);
}

tr:last-child td {
    border-bottom: none;
}

/* ============================================
   STATUS BADGES
============================================ */
.present,
.absent {
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 12px;
    text-transform: uppercase;
    font-weight: 600;
    display: inline-block;
    letter-spacing: 0.5px;
}

.present {
    background: #d4edda;
    color: var(--success-dark);
    border: 1px solid #c3e6cb;
    box-shadow: 0 2px 4px rgba(46, 125, 50, 0.2);
}

.absent {
    background: #f8d7da;
    color: var(--danger-dark);
    border: 1px solid #f5c6cb;
    box-shadow: 0 2px 4px rgba(198, 40, 40, 0.2);
}

/* ============================================
   NAVIGATION AREA
============================================ */
.navigation-area {
    margin: 30px 0;
    text-align: center;
}

.dashboard-btn {
    display: inline-flex;
    align-items: center;
    justify-content: space-between;
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    color: white;
    text-decoration: none;
    padding: 18px 30px;
    border-radius: 15px;
    font-weight: 600;
    min-width: 320px;
    transition: var(--transition-slow);
    box-shadow: 0 10px 20px rgba(118, 75, 162, 0.3);
}

.btn-content {
    display: flex;
    align-items: center;
    gap: 15px;
}

.dashboard-btn i {
    font-size: 1.2rem;
}

.arrow-icon {
    transition: transform 0.3s ease;
}

.dashboard-btn:hover {
    transform: translateY(-5px) scale(1.02);
    box-shadow: 0 15px 30px rgba(118, 75, 162, 0.5);
    background: linear-gradient(135deg, var(--secondary) 0%, var(--primary) 100%);
}

.dashboard-btn:hover .arrow-icon {
    transform: translateX(8px);
}

/* ============================================
   FOOTER
============================================ */
.main-footer {
    background: var(--glass);
    backdrop-filter: blur(10px);
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    padding: 20px 0;
    margin-top: 40px;
    width: 100%;
    position: relative;
    bottom: 0;
    left: 0;
    z-index: -1;
}

.footer-content {
    max-width: 1000px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 20px;
    color: white;
    font-size: 14px;
}

.footer-brand {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
    letter-spacing: 0.5px;
}

.footer-info {
    flex: 1;
    text-align: center;
    padding: 0 30px;
    opacity: 0.9;
}

.footer-info p {
    margin: 0;
    font-size: 13px;
    line-height: 1.4;
    color: rgba(255, 255, 255, 0.85);
}

.footer-info strong {
    color: var(--success);
}

.footer-status {
    display: flex;
    align-items: center;
    gap: 8px;
    opacity: 0.8;
}

.status-indicator {
    width: 8px;
    height: 8px;
    background: var(--success);
    border-radius: 50%;
    box-shadow: 0 0 8px var(--success);
    animation: pulse 2s infinite;
}

.footer-nav {
    display: flex;
    gap: 20px;
}

.footer-nav a {
    color: white;
    text-decoration: none;
    opacity: 0.7;
    transition: var(--transition);
}

.footer-nav a:hover {
    opacity: 1;
    text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
}

@keyframes pulse {
    0%, 100% {
        opacity: 0.4;
    }
    50% {
        opacity: 1;
    }
}

/* ============================================
   NOTIFICATION SYSTEM
============================================ */
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 16px 24px;
    border-radius: 12px;
    color: white;
    font-weight: 600;
    box-shadow: var(--shadow-lg);
    z-index: 10000;
    opacity: 0;
    transform: translateX(400px);
    transition: all 0.3s ease;
    max-width: 300px;
    backdrop-filter: blur(10px);
}

.notification.show {
    opacity: 1;
    transform: translateX(0);
}

.notification-success {
    background: linear-gradient(135deg, var(--success), #38ef7d);
}

.notification-error {
    background: linear-gradient(135deg, var(--danger), #ff6b6b);
}

.notification-info {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
}

/* ============================================
   RESPONSIVE DESIGN
============================================ */
@media (max-width: 900px) {
    th,
    td {
        font-size: 13px;
        padding: 8px;
    }

    button {
        font-size: 13px;
        padding: 8px 12px;
    }
}

@media (max-width: 600px) {
    .input-box {
        flex-direction: column;
        gap: 8px;
    }

    input[type="text"],
    input[type="number"],
    input[type="date"] {
        width: 100%;
        padding: 18px 20px;
        font-size: 18px;
    }

    .btn-group {
        flex-direction: column;
        gap: 8px;
    }

    .btn-group button {
        width: 100%;
        padding: 10px 0;
        font-size: 15px;
        border-radius: 8px;
        min-width: unset;
    }

    .add-btn {
        font-size: 18px;
        padding: 12px 0;
        width: 100%;
        max-width: 100%;
        min-width: unset;
    }

    .export-btn,
    .import-btn,
    .total-present-btn {
        width: 100%;
        font-size: 15px;
        padding: 12px 0;
        border-radius: 10px;
    }

    .context-menu {
        min-width: 180px !important;
        z-index: 999999 !important;
    }

    .context-menu .menu-item {
        padding: 12px 14px !important;
        font-size: 15px !important;
    }
    
    td.status-cell {
        margin-top: 5px;
        padding-top: 8px;
        padding-bottom: 8px;
        font-size: 11px;
    }
    
    .present,
    .absent {
        padding: 3px 6px;
        font-size: 9px;
    }

    th,
    td {
        font-size: 12px;
        padding: 6px;
    }

    .dashboard-btn {
        min-width: auto;
        width: 100%;
        padding: 15px 20px;
    }

    .footer-content {
        flex-direction: column;
        gap: 15px;
        text-align: center;
    }
}

@media (max-width: 480px) {
    th,
    td {
        font-size: 11px;
        padding: 5px;
    }

    button {
        font-size: 12px;
        padding: 6px 8px;
    }
}
</style>
</head>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<body>

<h1>ðŸ“‹ Student Attendance Register</h1>
<div class="navigation-area">
    <a href="at.html" class="dashboard-btn">
        <div class="btn-content">
            <i class="fa-solid fa-gauge-high"></i>
            <span>Go to Attendance Dashboard</span>
        </div>
        <i class="fa-solid fa-arrow-right-long arrow-icon"></i>
    </a>
</div>
<div class="container">

<div class="input-box">
    <input type="date" id="attendanceDate" placeholder="Select Date">
    <input type="number" id="rollNo" placeholder="Index Or Roll Number">
    <input type="text" id="studentName" placeholder="Student Name">
<div class="toolbar">
    <input type="text" id="searchStudent" placeholder="ðŸ” Search Name or Roll..." onkeyup="filterStudents()">
</div>
<button class="add-btn" onclick="addStudent()">
    <i class="fa-solid fa-circle-plus btn-icon"></i> Add Student
</button>


<button class="export-btn" onclick="exportBackup()">
    <i class="fa-solid fa-file-export btn-icon"></i> Export Student List
</button>

<button class="import-btn" onclick="document.getElementById('importFile').click()">
    <i class="fa-solid fa-file-import btn-icon"></i> Import Student List
</button>

<input type="file" id="importFile" accept=".json" hidden onchange="importBackup(event)">


<button onclick="countPresents()" class="total-present-btn">
    <i class="fa-solid fa-check-circle btn-icon"></i> Show Total Presents
</button>



</div>

    <table id="attendanceTable">
<tr>
    <th>S.No</th>
    <th>Roll No/Index</th>
    <th>Student Name</th>
    <th>Status</th>
    <th>Actions</th>
</tr>

    </table>

</div>


<footer class="main-footer">
    <div class="footer-content">
        <div class="footer-brand">
            <i class="fa-solid fa-graduation-cap"></i>
            <span>Attendance Manager 2025</span>
        </div>
        
        <div class="footer-info">
            <p><strong>Privacy First:</strong> Your data stays on your device using LocalStorage technology.</p>
        </div>

        <div class="footer-status">
            <span class="status-indicator"></span> System Online
        </div>
    </div>
</footer>

</div>
<script>
function countPresents() {
    const totalPresents = students.filter(student => student.status === "Present").length;
    alert(`Total students present: ${totalPresents}`);
    return totalPresents;
}
let sessionId = localStorage.getItem("currentSessionId");
if(!sessionId){
    alert("No session found! Go back to Dashboard.");
    window.location.href = "at.html";
}
let students = JSON.parse(localStorage.getItem("students_" + sessionId)) || [];

function saveData() {
    localStorage.setItem("students_" + sessionId, JSON.stringify(students));
}
// EXPORT BACKUP (JSON)
function exportBackup() {
    if (students.length === 0) {
        alert("No students to export!");
        return;
    }

    // Keep ONLY roll & name
    const cleanStudents = students.map(s => ({
        roll: s.roll,
        name: s.name
    }));

    const blob = new Blob(
        [JSON.stringify(cleanStudents, null, 2)],
        { type: "application/json" }
    );

    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `student_list_backup.json`;
    a.click();
    URL.revokeObjectURL(url);
}


// IMPORT BACKUP (JSON)
function importBackup(event) {
    const file = event.target.files[0];
    if (!file) return;

    if (!file.name.endsWith(".json")) {
        alert("Please select a valid JSON file!");
        return;
    }

    const reader = new FileReader();
    reader.onload = function (e) {
        try {
            const data = JSON.parse(e.target.result);

            if (!Array.isArray(data)) {
                alert("Invalid backup file!");
                return;
            }

            if (!confirm("This will replace the current student list. Continue?")) {
                return;
            }

            // Restore students with status reset
            students = data.map(s => ({
                roll: s.roll,
                name: s.name,
                status: "Not Marked"
            }));

            saveData();
            renderTable();
            alert("Student list imported successfully!");
        } catch {
            alert("Error reading backup file!");
        }
    };

    reader.readAsText(file);
    event.target.value = "";
}


function renderTable() {
    const table = document.getElementById("attendanceTable");
    // Hide all menus on render
document.querySelectorAll('.btn-group .context-menu').forEach(menu => {
    menu.style.display = 'none';
});

table.innerHTML = `
    <tr>
        <th>S.No</th>
        <th>Roll No/Index</th>
        <th>Student Name</th>
        <th>Status</th>
        <th>Actions</th>
    </tr>
`;


    students.forEach((student, index) => {
        const row = table.insertRow();

row.oncontextmenu = (e) => {
    e.preventDefault();
    openMenuAtCursor(e, index);
};


// Serial number (1, 2, 3...)
row.insertCell(0).innerText = index + 1;

// Roll & Name
row.insertCell(1).innerText = student.roll;
row.insertCell(2).innerText = student.name;

// Status cell with margin-top
const statusCell = row.insertCell(3);
statusCell.className = "status-cell " + (student.status === "Present" ? "present" :
                       student.status === "Absent" ? "absent" : "");
statusCell.innerText = student.status;
statusCell.style.marginTop = "10px";
statusCell.style.paddingTop = "15px";

const actionCell = row.insertCell(4);
actionCell.className = "action-cell";

actionCell.innerHTML = `
<div class="btn-group">
    <button class="present-btn" onclick="event.stopPropagation(); markAttendance(${index}, 'Present')">Present</button>
    <button class="absent-btn" onclick="event.stopPropagation(); markAttendance(${index}, 'Absent')">Absent</button>
    <button class="delete-btn" onclick="event.stopPropagation(); deleteStudent(${index})">Delete</button>
    
    <!-- 3 dots menu button -->
    <span class="menu-btn" onclick="toggleRowMenu(this, ${index});" title="More options">â‹®</span>

    <!-- Context menu hidden by default -->
<div class="context-menu" id="menu-${index}" onclick="event.stopPropagation();">
    <div onclick="event.stopPropagation(); renameStudent(${index});" class="menu-item">
        <i class="fa-solid fa-pen"></i> Rename Student
    </div>
    <div onclick="event.stopPropagation(); changeRollNumber(${index});" class="menu-item">
        <i class="fa-solid fa-hashtag"></i> Change Roll Number
    </div>
    <div onclick="event.stopPropagation(); changePosition(${index});" class="menu-item">
        <i class="fa-solid fa-arrows-up-down"></i> Change Position
    </div>
    <div onclick="event.stopPropagation(); duplicateStudent(${index});" class="menu-item">
        <i class="fa-solid fa-copy"></i> Duplicate Student
    </div>
</div>

</div>

`;



    });
}
/* Add these functions to your index.html <script> section */

// Search functionality is now enhanced below in ADDITIONAL ENHANCED FEATURES section

// 2. Bulk Actions
function markAll(status) {
    if(!confirm(`Mark everyone as ${status}?`)) return;
    students.forEach(s => s.status = status);
    saveData();
    renderTable();
}

// 3. Sorting Logic
function sortStudents() {
    students.sort((a, b) => a.name.localeCompare(b.name));
    saveData();
    renderTable();
}

// Global variable to track open menu
let openMenuId = null;

function toggleRowMenu(button, index) {
    if (event) {
        event.stopPropagation();
    }
    
    const btnGroup = button.closest('.btn-group');
    if (!btnGroup) return;
    
    const menu = btnGroup.querySelector('.context-menu');
    if (!menu) return;
    
    const menuId = `menu-${index}`;

    // If clicking the same menu, close it
    if (openMenuId === menuId && menu.style.display === 'block') {
        menu.style.display = 'none';
        openMenuId = null;
        return;
    }

    // Hide all other menus first
    document.querySelectorAll('.btn-group .context-menu').forEach(m => {
        if (m !== menu) {
            m.style.display = 'none';
        }
    });

    // Show the clicked menu immediately
    menu.style.display = 'block';
    menu.style.visibility = 'visible';
    menu.style.pointerEvents = 'auto';
    menu.style.zIndex = '999999';
    openMenuId = menuId;

    // Position the menu after a small delay to ensure layout is calculated
    requestAnimationFrame(() => {
        positionMenu(menu, button);
    });
}

function positionMenu(menu, button) {
    if (!menu || !button) return;
    
    // Reset positioning
    menu.style.top = '';
    menu.style.bottom = '';
    menu.style.left = '';
    menu.style.right = '';
    menu.style.position = 'absolute';
    menu.style.zIndex = '999999';

    // Get positions
    const buttonRect = button.getBoundingClientRect();
    const viewportHeight = window.innerHeight;
    const viewportWidth = window.innerWidth;
    
    // Get table and footer positions
    const table = document.getElementById('attendanceTable');
    const tableRect = table ? table.getBoundingClientRect() : null;
    const tableBottom = tableRect ? tableRect.bottom : viewportHeight;
    
    const footer = document.querySelector('.main-footer');
    const footerRect = footer ? footer.getBoundingClientRect() : null;
    const footerTop = footerRect ? footerRect.top : viewportHeight;

    // Get menu height
    menu.style.visibility = 'hidden';
    const menuRect = menu.getBoundingClientRect();
    const menuHeight = menuRect.height || 200; // fallback height
    menu.style.visibility = 'visible';
    
    const spaceBelow = viewportHeight - buttonRect.bottom;
    const spaceAbove = buttonRect.top;
    const distanceToTableBottom = tableBottom - buttonRect.bottom;
    const distanceToFooter = footerTop - buttonRect.bottom;
    const safeMargin = 30;

    // Position below button by default
    menu.style.top = '100%';
    menu.style.right = '0';
    menu.style.left = 'auto';
    menu.style.marginTop = '5px';
    menu.style.marginBottom = '0';

    // Check if menu would go below viewport, too close to table bottom, or too close to footer
    // Open up if any of these conditions are met
    const shouldOpenUp = distanceToTableBottom < 100 || 
                        distanceToFooter < 100 || 
                        (spaceBelow < menuHeight + safeMargin && spaceAbove > spaceBelow);

    if (shouldOpenUp) {
        menu.style.top = 'auto';
        menu.style.bottom = '100%';
        menu.style.marginTop = '0';
        menu.style.marginBottom = '5px';
    }

    // Check if menu goes off right edge
    if (buttonRect.right + 180 > viewportWidth) {
        menu.style.right = 'auto';
        menu.style.left = '0';
    }

    // Check if menu goes off left edge
    if (buttonRect.left < 20) {
        menu.style.left = '0';
        menu.style.right = 'auto';
    }
    
    // Ensure menu is clickable
    menu.style.pointerEvents = 'auto';
}

// Close menus when clicking outside (but not when clicking inside menu)
document.addEventListener("click", (e) => {
    // Check if click is inside a menu or menu item
    const clickedMenu = e.target.closest('.context-menu');
    const clickedMenuBtn = e.target.closest('.menu-btn');
    const clickedMenuItem = e.target.closest('.menu-item');
    
    // Don't close if clicking inside menu or menu button
    if (!clickedMenu && !clickedMenuBtn && !clickedMenuItem) {
        document.querySelectorAll(".btn-group .context-menu").forEach(menu => {
            menu.style.display = "none";
        });
        openMenuId = null;
    }
}, true); // Use capture phase to catch events early

// Close menus on Escape key
document.addEventListener("keydown", (e) => {
    if (e.key === 'Escape') {
        document.querySelectorAll(".btn-group .context-menu").forEach(menu => {
            menu.style.display = "none";
        });
        openMenuId = null;
    }
});

// Rename student
function renameStudent(index) {
    closeAllMenus();
    setTimeout(() => {
        const newName = prompt("Enter new student name:", students[index].name);
        if (newName && newName.trim() !== "") {
            students[index].name = newName.trim();
            saveData();
            renderTable();
            showNotification("Student renamed successfully!");
        }
    }, 100);
    return false;
}

// Change roll number
function changeRollNumber(index) {
    closeAllMenus();
    setTimeout(() => {
        const newRoll = prompt("Enter new roll number/index:", students[index].roll);
        if (newRoll && newRoll.trim() !== "") {
            // Check if roll number already exists
            const existingIndex = students.findIndex((s, i) => i !== index && s.roll === newRoll.trim());
            if (existingIndex !== -1) {
                alert("This roll number is already assigned to another student!");
                return;
            }
            students[index].roll = newRoll.trim();
            saveData();
            renderTable();
            showNotification("Roll number updated successfully!");
        }
    }, 100);
    return false;
}

// Change position
function changePosition(currentIndex) {
    closeAllMenus();
    setTimeout(() => {
        const totalStudents = students.length;
        if (totalStudents <= 1) {
            alert("Cannot change position with only one student!");
            return;
        }

        const newPositionStr = prompt(`Enter new position (1 to ${totalStudents}):`);
        const newPosition = parseInt(newPositionStr);

        if (isNaN(newPosition) || newPosition < 1 || newPosition > totalStudents) {
            alert("Invalid position!");
            return;
        }

        if (newPosition === currentIndex + 1) {
            alert("Student is already at this position!");
            return;
        }

        // Move student to new position
        const student = students.splice(currentIndex, 1)[0];
        students.splice(newPosition - 1, 0, student);

        saveData();
        renderTable();
        showNotification("Student position changed successfully!");
    }, 100);
    return false;
}

// Duplicate student
function duplicateStudent(index) {
    closeAllMenus();
    setTimeout(() => {
        const student = students[index];
        const newStudent = {
            roll: student.roll + " (Copy)",
            name: student.name + " (Copy)",
            status: "Not Marked"
        };
        
        students.splice(index + 1, 0, newStudent);
        saveData();
        renderTable();
        showNotification("Student duplicated successfully!");
    }, 100);
    return false;
}


// Helper: close all menus
function closeAllMenus() {
    document.querySelectorAll(".btn-group .context-menu").forEach(menu => {
        menu.style.display = "none";
    });
    openMenuId = null;
}

// Notification system
function showNotification(message, type = "success") {
    // Remove existing notification if any
    const existing = document.querySelector('.notification');
    if (existing) {
        existing.remove();
    }

    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    document.body.appendChild(notification);

    // Animate in
    setTimeout(() => {
        notification.classList.add('show');
    }, 10);

    // Remove after 3 seconds
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
            notification.remove();
        }, 300);
    }, 3000);
}

function addStudent() {
    const roll = document.getElementById("rollNo").value;
    const name = document.getElementById("studentName").value;

    if (!roll || !name) {
        alert("Enter roll number/index and student name!");
        return;
    }
    students.push({ roll, name, status: "Not Marked" });
    saveData();
    renderTable();

    document.getElementById("rollNo").value = "";
    document.getElementById("studentName").value = "";
}

function markAttendance(index, status) {
    students[index].status = status;
    saveData();
    renderTable();
}
function createNewSession() {
    let dateInput = document.getElementById("attendanceDate").value;
    if (!dateInput) {
        alert("Please select a date for the session.");
        return;
    }

    // Create unique session ID
    let sessionId = Date.now();
    localStorage.setItem("currentSessionId", sessionId);

    // Save the date for this session
    localStorage.setItem("attendanceDate_" + sessionId, dateInput);

    // Copy existing students if available
    let prevSessionId = localStorage.getItem("currentSessionId");
    let students = [];
    if (prevSessionId && localStorage.getItem("students_" + prevSessionId)) {
        students = JSON.parse(localStorage.getItem("students_" + prevSessionId));
    }
    localStorage.setItem("students_" + sessionId, JSON.stringify(students));

    renderTable(); // refresh the table for this new session
}


function deleteStudent(index) {
    if(confirm("Delete this student?")){
        students.splice(index,1);
        saveData();
        renderTable();
    }
}

renderTable();

// ============================================
// ADDITIONAL ENHANCED FEATURES
// ============================================

// Auto-save on any change
let autoSaveTimeout;
function autoSave() {
    clearTimeout(autoSaveTimeout);
    autoSaveTimeout = setTimeout(() => {
        saveData();
    }, 500);
}

// Enhanced search with highlighting
function filterStudents() {
    const query = document.getElementById('searchStudent').value.toLowerCase().trim();
    const rows = document.querySelectorAll('#attendanceTable tr:not(:first-child)');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const name = row.cells[2].innerText.toLowerCase();
        const roll = row.cells[1].innerText.toLowerCase();
        const matches = name.includes(query) || roll.includes(query);
        
        row.style.display = matches ? "" : "none";
        if (matches) visibleCount++;
        
        // Highlight matching text
        if (query && matches) {
            highlightText(row.cells[1], query);
            highlightText(row.cells[2], query);
        } else {
            removeHighlight(row.cells[1]);
            removeHighlight(row.cells[2]);
        }
    });
    
    // Show search results count
    if (query) {
        showSearchResults(visibleCount, students.length);
    } else {
        hideSearchResults();
    }
}

function highlightText(cell, query) {
    const text = cell.innerText;
    const regex = new RegExp(`(${query})`, 'gi');
    cell.innerHTML = text.replace(regex, '<mark>$1</mark>');
}

function removeHighlight(cell) {
    cell.innerHTML = cell.innerText;
}

// Search results indicator
function showSearchResults(visible, total) {
    let indicator = document.getElementById('searchResults');
    if (!indicator) {
        indicator = document.createElement('div');
        indicator.id = 'searchResults';
        indicator.className = 'search-results';
        const toolbar = document.querySelector('.toolbar');
        toolbar.appendChild(indicator);
    }
    indicator.textContent = `Showing ${visible} of ${total} students`;
    indicator.style.display = 'block';
}

function hideSearchResults() {
    const indicator = document.getElementById('searchResults');
    if (indicator) {
        indicator.style.display = 'none';
    }
}

// Statistics display
function showStatistics() {
    const total = students.length;
    const present = students.filter(s => s.status === "Present").length;
    const absent = students.filter(s => s.status === "Absent").length;
    const notMarked = students.filter(s => s.status === "Not Marked").length;
    const percentage = total > 0 ? Math.round((present / total) * 100) : 0;
    
    const stats = `
        ðŸ“Š Attendance Statistics:
        
        Total Students: ${total}
        Present: ${present} (${percentage}%)
        Absent: ${absent}
        Not Marked: ${notMarked}
    `;
    
    alert(stats);
}

// Bulk mark all as present
function markAllPresent() {
    if (students.length === 0) {
        alert("No students to mark!");
        return;
    }
    if (confirm(`Mark all ${students.length} students as Present?`)) {
        students.forEach(s => s.status = "Present");
        saveData();
        renderTable();
        showNotification(`All ${students.length} students marked as Present!`);
    }
}

// Bulk mark all as absent
function markAllAbsent() {
    if (students.length === 0) {
        alert("No students to mark!");
        return;
    }
    if (confirm(`Mark all ${students.length} students as Absent?`)) {
        students.forEach(s => s.status = "Absent");
        saveData();
        renderTable();
        showNotification(`All ${students.length} students marked as Absent!`);
    }
}

// Clear all attendance (reset to Not Marked)
function clearAllAttendance() {
    if (students.length === 0) {
        alert("No students to clear!");
        return;
    }
    if (confirm("Clear all attendance marks? This will reset all students to 'Not Marked'.")) {
        students.forEach(s => s.status = "Not Marked");
        saveData();
        renderTable();
        showNotification("All attendance cleared!");
    }
}

// Sort students by name
function sortByName() {
    students.sort((a, b) => a.name.localeCompare(b.name));
    saveData();
    renderTable();
    showNotification("Students sorted by name!");
}

// Sort students by roll number
function sortByRoll() {
    students.sort((a, b) => {
        const rollA = parseInt(a.roll) || a.roll;
        const rollB = parseInt(b.roll) || b.roll;
        return rollA > rollB ? 1 : rollA < rollB ? -1 : 0;
    });
    saveData();
    renderTable();
    showNotification("Students sorted by roll number!");
}

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
    // Ctrl/Cmd + F: Focus search
    if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
        e.preventDefault();
        const searchInput = document.getElementById('searchStudent');
        if (searchInput) {
            searchInput.focus();
            searchInput.select();
        }
    }
    
    // Ctrl/Cmd + S: Save (prevent default browser save)
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        saveData();
        showNotification("Data saved!", "success");
    }
    
    // Delete key: Delete selected student (if any)
    if (e.key === 'Delete' && e.target.tagName !== 'INPUT') {
        // Could add selection logic here
    }
});

// Add CSS for search results and mark highlighting
const style = document.createElement('style');
style.textContent = `
    .search-results {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(255, 255, 255, 0.9);
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        color: var(--primary);
        font-weight: 600;
        display: none;
    }
    
    mark {
        background: #ffeb3b;
        color: #333;
        padding: 2px 4px;
        border-radius: 3px;
        font-weight: 600;
    }
    
    .context-menu {
        animation: slideDown 0.2s ease;
    }
    
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
`;
document.head.appendChild(style);

// Initialize date picker with today's date if session date exists
window.addEventListener('load', () => {
    const sessionId = localStorage.getItem("currentSessionId");
    if (sessionId) {
        const date = localStorage.getItem("attendanceDate_" + sessionId);
        if (date) {
            const dateInput = document.getElementById("attendanceDate");
            if (dateInput) {
                dateInput.value = date;
            }
        }
    }
    
    // Auto-focus first input if no students
    if (students.length === 0) {
        const rollInput = document.getElementById("rollNo");
        if (rollInput) {
            setTimeout(() => rollInput.focus(), 100);
        }
    }
});

console.log("Enhanced Attendance System Loaded!");
</script>

</body>
</html>





